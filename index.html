<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Promotion Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 min-h-screen text-slate-800">

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="text-center mb-10 fade-in">
            <h1
                class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 mb-2">
                Promotion Tracker
            </h1>
            <p class="text-slate-500">Upload the Seniority List (.docx) to predict promotion paths</p>
        </header>

        <!-- Upload Section -->
        <div class="glass rounded-2xl shadow-xl p-8 mb-8 fade-in" id="upload-section">
            <div
                class="flex flex-col items-center justify-center border-2 border-dashed border-indigo-300 rounded-xl p-10 hover:bg-indigo-50 transition-colors cursor-pointer relative">
                <input type="file" id="fileInput" accept=".docx"
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <svg class="w-16 h-16 text-indigo-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                    </path>
                </svg>
                <p class="text-lg font-semibold text-indigo-700">Click to Upload Word File (.docx)</p>
                <p class="text-sm text-slate-400 mt-2">Maximum file size: 10MB</p>
            </div>

            <div id="loading" class="hidden mt-4 text-center">
                <div class="text-indigo-600 flex items-center justify-center gap-2">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span>Processing file...</span>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error-box" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg text-left">
                <h3 class="font-bold text-red-700 mb-2">Parsing Error</h3>
                <p class="text-red-600 text-sm mb-2" id="error-message">Unknown error</p>
                <details class="text-xs text-slate-500">
                    <summary class="cursor-pointer hover:text-slate-700">View Raw Data / Stack Trace</summary>
                    <pre id="error-stack"
                        class="mt-2 p-2 bg-slate-100 rounded overflow-x-auto whitespace-pre-wrap"></pre>
                    <div class="mt-2 font-mono" id="raw-html-preview"></div>
                </details>
            </div>
        </div>

        <!-- Dashboard (Hidden initially) -->
        <div id="dashboard" class="hidden fade-in">
            <!-- Stats -->
            <!-- Stats Removed as per request -->

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Selection Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                        <h2 class="text-lg font-bold mb-4 text-slate-800 border-b pb-2">Select Employee</h2>
                        <input type="text" id="searchEmployee" placeholder="Search by Name or PEN..."
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-4 bg-slate-50">
                        <div class="h-[500px] overflow-y-auto space-y-2 pr-1 custom-scrollbar" id="employeeList">
                            <!-- Employee Items injected here -->
                        </div>
                        <div class="mt-4 text-center">
                            <button onclick="location.reload()" class="text-sm text-indigo-500 hover:underline">Upload
                                New File</button>
                        </div>
                    </div>
                </div>

                <!-- Forecast Panel -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-8 min-h-[600px]">
                        <div id="empty-state" class="h-full flex flex-col items-center justify-center text-slate-300">
                            <svg class="w-20 h-20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            <p class="text-lg">Select an employee to see their promotion forecast</p>
                        </div>

                        <div id="forecast-content" class="hidden">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-800" id="f-name">Name</h2>
                                    <p class="text-slate-500 text-sm">PEN: <span id="f-pen"
                                            class="font-mono bg-slate-100 px-1 rounded"></span> | DOB: <span
                                            id="f-dob"></span></p>
                                    <p class="text-indigo-600 font-semibold mt-1">Current: <span
                                            id="f-current-role"></span></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-slate-400 uppercase">Retirement Date</p>
                                    <p class="text-xl font-bold text-pink-600" id="f-retire-date">-</p>
                                </div>
                            </div>

                            <div class="relative border-l-2 border-indigo-100 pl-8 ml-4 space-y-10 py-4" id="timeline">
                                <!-- Timeline items injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals or Parsing logic -->
    <script>
        // --- CONFIGURATION ---
        const HIERARCHY = [
            'Clerk',
            'Senior Clerk',
            'Head Clerk',
            'Junior Superintendent', // JS
            'Senior Superintendent', // SS
            'Accounts Officer', // AO
            'Administrative Assistant', // AA
            'Manager'
        ];

        const ROLE_MAPPINGS = {
            // Priority: Exact matches from User's Clean List
            'manager': 'Manager',
            'accounts officer': 'Accounts Officer',
            'administrative assistant': 'Administrative Assistant',
            'senior superintendent': 'Senior Superintendent',
            'junior superintendent': 'Junior Superintendent',
            'head clerk': 'Head Clerk',
            'senior clerk': 'Senior Clerk',
            'clerk': 'Clerk',

            // Common abbreviations (kept just in case of typos, but lower priority)
            'ao': 'Accounts Officer',
            'aa': 'Administrative Assistant',
            'ss': 'Senior Superintendent',
            'js': 'Junior Superintendent',
            'hc': 'Head Clerk',
            'sr. clerk': 'Senior Clerk',
            'sr clerk': 'Senior Clerk',
        };

        // --- STATE ---
        let employees = [];
        let rawHtmlCache = '';

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const errorBox = document.getElementById('error-box');
        const errorMsg = document.getElementById('error-message');
        const errorStack = document.getElementById('error-stack');
        const rawHtmlPreview = document.getElementById('raw-html-preview');
        const dashboard = document.getElementById('dashboard');
        const uploadSection = document.getElementById('upload-section');
        const employeeList = document.getElementById('employeeList');
        const searchInput = document.getElementById('searchEmployee');

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleFileUpload);
        searchInput.addEventListener('input', (e) => renderEmployeeList(e.target.value));

        // --- LOGIC: PARSING ---
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            loading.classList.remove('hidden');
            errorBox.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = function (event) {
                const arrayBuffer = event.target.result;
                mammoth.convertToHtml({ arrayBuffer: arrayBuffer })
                    .then(displayResult)
                    .catch((err) => handleError(err, 'Mammoth Conversion Error'));
            };
            reader.readAsArrayBuffer(file);
        }

        function displayResult(result) {
            rawHtmlCache = result.value;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = result.value;

            const table = tempDiv.querySelector('table');
            if (!table) {
                // Warning, maybe not a table?
                handleError({ message: 'No table found in the DOCX file. The content might be formatted as text/shapes.' }, 'Structure Error');
                return;
            }

            try {
                parseTable(table);
                if (employees.length === 0) {
                    throw new Error("Table parsed but no valid employee rows found. Check column headers.");
                }
                const invalidIds = employees.some(e => typeof e.id === 'undefined');
                if (invalidIds) throw new Error("Internal Logic Error: Employees assigned undefined IDs.");

                runSimulation();

                // Success Transition
                loading.classList.add('hidden');
                uploadSection.classList.add('hidden');
                dashboard.classList.remove('hidden');
                renderStats();
                renderEmployeeList();
            } catch (err) {
                handleError(err, 'Parsing Logic Error');
            }
        }

        function parseTable(table) {
            const rows = Array.from(table.querySelectorAll('tr'));
            employees = [];

            // Dynamic Column Mapping
            let nameIdx = -1;
            let dobIdx = -1;
            let serviceIdx = -1;
            let remarksIdx = -1;

            // Header Detection Scan (First 10 rows)
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const cells = Array.from(rows[i].querySelectorAll('td')).map(td => td.innerText.trim().toLowerCase());

                if (dobIdx === -1) dobIdx = cells.findIndex(c => c.includes('birth') || c.includes('dob'));
                if (nameIdx === -1) nameIdx = cells.findIndex(c => c.includes('name'));
                if (remarksIdx === -1) remarksIdx = cells.findIndex(c => c.includes('remark') || c.includes('designation'));
                if (serviceIdx === -1) serviceIdx = cells.findIndex(c => c.includes('continu') && (c.includes('service') || c.includes('post')));
            }

            console.log('Detected Columns:', { nameIdx, dobIdx, serviceIdx, remarksIdx });

            // Fallbacks
            // If DOB not found in header, we'll auto-detect in rows
            // If Name not found, assume left of DOB
            // If Remarks not found, assume Last Column

            rows.forEach((row, rowIndex) => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.innerText.trim());
                if (cells.length < 4) return;

                // 1. Find DOB
                // If header mapping worked, use it. Else search.
                let currentRowDobIdx = -1;

                const dateRegex = /\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}/;

                // If we detected a DOB column index, verify it has a date
                if (dobIdx !== -1 && cells[dobIdx] && dateRegex.test(cells[dobIdx])) {
                    currentRowDobIdx = dobIdx;
                } else {
                    // Search for first date-like cell
                    currentRowDobIdx = cells.findIndex(c => dateRegex.test(c));
                }

                if (currentRowDobIdx === -1) return; // Skip non-data rows

                const dob = extractDate(cells[currentRowDobIdx]);
                if (!dob) return;

                // 2. Find Name
                // Default: column 1 (index 1) if DOB is index 2. Or relative to DOB
                let nameVal = "Unknown";
                if (nameIdx !== -1 && cells[nameIdx]) {
                    nameVal = cells[nameIdx];
                } else {
                    // Fallback: Cell before DOB? Or Column 1?
                    const potentialNameIdx = Math.max(0, currentRowDobIdx - 1);
                    nameVal = cells[potentialNameIdx] || "Unknown";
                }

                // 3. Find Remarks (Designation)
                let remarksVal = "";
                if (remarksIdx !== -1 && cells[remarksIdx]) {
                    remarksVal = cells[remarksIdx];
                } else {
                    remarksVal = cells[cells.length - 1]; // Assume last column
                }

                // 4. Find Service Date (Retirement Rule)
                // Search for date AFTER DOB
                let serviceDate = null;
                if (serviceIdx !== -1 && cells[serviceIdx] && dateRegex.test(cells[serviceIdx])) {
                    serviceDate = extractDate(cells[serviceIdx]);
                } else {
                    for (let i = currentRowDobIdx + 1; i < cells.length; i++) {
                        const d = extractDate(cells[i]);
                        if (d) {
                            serviceDate = d;
                            break;
                        }
                    }
                }

                // FIX: Use employees.length as the ID to ensure 0-based sequential indexing for this array.
                // Do NOT use rowIndex because skipped rows create gaps, and we need array[id] lookup to work.
                const newId = employees.length;

                employees.push({
                    id: newId,
                    rawName: nameVal.replace(/[\r\n]+/g, ' ').trim(),
                    dob: dob,
                    serviceDate: serviceDate,
                    originalDesignation: normalizeDesignation(remarksVal),
                    currentDesignation: normalizeDesignation(remarksVal),
                    history: [],
                    retirementDate: calculateRetirementDate(dob, serviceDate)
                });
            });
        }

        function extractDate(str) {
            if (!str) return null;
            const m = str.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
            if (!m) return null;
            return new Date(`${m[2]}/${m[1]}/${m[3]}`); // MM/DD/YYYY
        };

        function normalizeDesignation(text) {
            if (!text) return 'Clerk';
            const lower = text.toLowerCase().trim();

            // Direct lookup first (fast & accurate for clean data)
            if (ROLE_MAPPINGS[lower]) return ROLE_MAPPINGS[lower];

            // Fallback: Includes (for 'Senior Superintendent (Hg)' etc)
            for (const [key, value] of Object.entries(ROLE_MAPPINGS)) {
                // Word boundary check for short keys (2 chars) to avoid false positives
                if (key.length <= 2) {
                    const regex = new RegExp(`\\b${key}\\b`, 'i');
                    if (regex.test(lower)) return value;
                } else {
                    if (lower.includes(key)) return value;
                }
            }
            return 'Clerk';
        }

        function handleError(err, context = 'Error') {
            console.error(err);
            loading.classList.add('hidden');
            errorBox.classList.remove('hidden');

            errorMsg.textContent = `${context}: ${err.message || err}`;
            errorStack.textContent = err.stack || '';

            // Show snippet of HTML if available
            if (rawHtmlCache) {
                rawHtmlPreview.textContent = "Raw HTML Snippet:\n" + rawHtmlCache.substring(0, 1000) + "...";
            }
        }

        // --- LOGIC: DATES ---
        function calculateRetirementDate(dob, serviceStart) {
            if (!dob) return null;

            let retireAge = 56;
            const cutoff = new Date('2013-04-01');
            if (serviceStart && serviceStart >= cutoff) {
                retireAge = 60;
            }

            const birthMonth = dob.getMonth();
            const birthDate = dob.getDate();
            const birthYear = dob.getFullYear();

            let retireYear = birthYear + retireAge;
            let retireMonth = birthMonth;

            if (birthDate === 1) {
                retireMonth = birthMonth - 1;
            } else {
                // End of current month
            }

            // new Date(Year, Month + 1, 0) gives last day of Month
            return new Date(retireYear, retireMonth + 1, 0);
        }

        function formatDate(d) {
            if (!d) return '-';
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        // --- LOGIC: SIMULATION ---
        let simulationLog = [];

        function runSimulation() {
            // Reset State for Simulation
            let simState = employees.map(e => ({ ...e, currentRole: e.originalDesignation }));
            let events = [];
            simulationLog = [];
            let pendingVacancies = {}; // { 'Manager': 0, 'Accounts Officer': 0 ... }
            HIERARCHY.forEach(r => pendingVacancies[r] = 0);

            // 1. Identify Retirement Events
            simState.forEach((e, idx) => {
                if (e.retirementDate) {
                    events.push({
                        date: e.retirementDate,
                        type: 'ITEM_RETIREMENT',
                        empIdx: idx,
                        // Capture role at start, but checking at runtime is safer?
                        // We'll trust the currentRole state at the moment of event processing
                    });
                }
            });

            events.sort((a, b) => a.date - b.date);

            // 2. Process Events Chronologically
            events.forEach(evt => {
                const retiree = simState[evt.empIdx];
                const vacatedRole = retiree.currentRole;
                const date = evt.date;

                // Log
                simulationLog.push({
                    date: date,
                    type: 'Retirement',
                    role: vacatedRole,
                    name: retiree.rawName,
                    details: `Retires from ${vacatedRole}`
                });

                retiree.currentRole = 'Retired';

                // Only trigger vacancy chain if they held a real role
                if (vacatedRole !== 'Retired' && HIERARCHY.includes(vacatedRole)) {
                    processVacancy(vacatedRole, date, simState, pendingVacancies);
                }
            });

            renderSimulationLog();
        }

        function processVacancy(role, date, simState, pendingVacancies) {
            const roleIdx = HIERARCHY.indexOf(role);
            if (roleIdx <= 0) return; // Base level (Clerk) has no feeder from below in this sim

            const sourceRole = HIERARCHY[roleIdx - 1];

            // Promotion Date: Day after vacancy triggers
            const promoteDate = new Date(date);
            promoteDate.setDate(promoteDate.getDate() + 1);

            // 1. Find Candidates
            const candidates = simState.filter((e) => {
                if (e.currentRole !== sourceRole) return false;
                if (e.retirementDate && e.retirementDate < promoteDate) return false;
                return true;
            });

            candidates.sort((a, b) => a.id - b.id); // Seniority by ID

            if (candidates.length > 0) {
                const luckyWinner = candidates[0];

                // 2. Promote
                luckyWinner.currentRole = role;

                if (employees[luckyWinner.id]) {
                    employees[luckyWinner.id].history.push({
                        date: promoteDate,
                        role: role
                    });
                }

                simulationLog.push({
                    date: promoteDate,
                    type: 'Promotion',
                    role: role,
                    name: luckyWinner.rawName,
                    details: `Promoted to ${role} (from ${sourceRole})`
                });

                // 3. CHECK UPWARDS (The Fix)
                // Now that 'role' has a new occupant (luckyWinner), 
                // check if 'role + 1' has been waiting for a candidate.
                const nextRoleIdx = roleIdx + 1;
                if (nextRoleIdx < HIERARCHY.length) {
                    const nextRole = HIERARCHY[nextRoleIdx];
                    if (pendingVacancies[nextRole] > 0) {
                        // Conserve checking: 
                        // The 'date' passed to recursive call determines the promoteDate = date + 1.
                        // If we use the original vacancy date, it might be in the past. 
                        // If we use 'promoteDate' (today), they get promoted tomorrow.
                        // Immedate fill logic: pass 'date' such that date+1 = promoteDate?
                        // Or just pass promoteDate - 1? 

                        // Let's say Manager vacancy happened May 31. Pending=1.
                        // Today is June 1 (promoteDate). Potty became AO.
                        // We want Potty to become Manager on June 1 (same day) or June 2?
                        // Usually same day double-jump is rare, but effectively they fill the slot.
                        // Let's assume sequential days for clarity or same day?
                        // If we iterate immediately, they might get double promoted same day.

                        pendingVacancies[nextRole]--;

                        simulationLog.push({
                            date: promoteDate,
                            type: 'Vacancy Fill',
                            role: nextRole,
                            name: 'System',
                            details: `Pending vacancy for ${nextRole} triggered by new ${role}`
                        });

                        // We pass 'date' so that the next processVacancy calc (date+1) results in promoteDate.
                        // So if we want result to be promoteDate, we pass promoteDate - 1 day.
                        const OneDayBefore = new Date(promoteDate);
                        OneDayBefore.setDate(OneDayBefore.getDate() - 1);

                        processVacancy(nextRole, OneDayBefore, simState, pendingVacancies);
                    }
                }

                // 4. FILL HOLE DOWNWARDS (Standard Chain)
                processVacancy(sourceRole, date, simState, pendingVacancies);

            } else {
                // No candidates available right now.
                // Mark as Pending.
                if (pendingVacancies[role] !== undefined) {
                    pendingVacancies[role]++;

                    simulationLog.push({
                        date: promoteDate,
                        type: 'Unfilled',
                        role: role,
                        name: '-',
                        details: `No eligible candidates from ${sourceRole}. Added to Pending Queue (Count: ${pendingVacancies[role]})`
                    });
                }
            }
        }

        function toggleLog() {
            const content = document.getElementById('log-wrapper');
            content.classList.toggle('hidden');
        }

        function renderSimulationLog() {
            let container = document.getElementById('debug-log-container');
            if (!container) {
                // Create it if missing, maybe at bottom
                const dashboard = document.getElementById('dashboard');
                const logDiv = document.createElement('div');
                logDiv.innerHTML = `
                    <div class="mt-12 bg-slate-50 rounded-xl border border-slate-200 p-6" id="debug-log-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700">Simulation Event Log</h3>
                            <button onclick="toggleLog()" class="text-sm bg-white border border-slate-300 text-slate-600 px-3 py-1 rounded hover:bg-slate-50 shadow-sm transition-colors">
                                Show/Hide Log
                            </button>
                        </div>
                        <div class="h-96 hidden overflow-y-auto font-mono text-xs bg-white border p-4 rounded shadow-inner custom-scrollbar" id="log-wrapper">
                            <div id="sim-log-content"></div>
                        </div>
                    </div>
                `;
                dashboard.appendChild(logDiv);
            }

            const content = document.getElementById('sim-log-content');
            if (content) {
                content.innerHTML = simulationLog.map(log => {
                    const color = log.type === 'Retirement' ? 'text-red-600' : (log.type === 'Promotion' ? 'text-green-600' : 'text-slate-400');
                    return `<div class="border-b border-slate-100 py-1 flex gap-4">
                        <span class="text-slate-500 w-24 shrink-0">${formatDate(log.date)}</span>
                        <span class="${color} font-bold w-24 shrink-0">${log.type}</span>
                        <span class="font-semibold text-slate-800 w-48 shrink-0 truncate">${log.role}</span>
                        <span class="truncate flex-1 text-slate-700" title="${log.details}">${log.details} - <b>${log.name}</b></span>
                    </div>`;
                }).join('');
            }
        }

        // --- UI ---
        function renderEmployeeList(filter = '') {
            employeeList.innerHTML = '';
            const lowerFilter = filter.toLowerCase();

            employees.forEach(emp => {
                if (emp.rawName.toLowerCase().includes(lowerFilter)) {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-indigo-50 cursor-pointer rounded border border-transparent hover:border-indigo-100 transition-all';
                    div.onclick = () => showForecast(emp);
                    div.innerHTML = `
                        <div class="font-semibold text-slate-700">${emp.rawName}</div>
                        <div class="text-xs text-slate-400 flex justify-between">
                            <span>${emp.originalDesignation}</span>
                            <span>Ret: ${formatDate(emp.retirementDate)}</span>
                        </div>
                    `;
                    employeeList.appendChild(div);
                }
            });
        }

        function showForecast(emp) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('forecast-content').classList.remove('hidden');

            document.getElementById('f-name').textContent = emp.rawName;
            document.getElementById('f-pen').textContent = 'List #: ' + (emp.id + 1);
            document.getElementById('f-dob').textContent = formatDate(emp.dob);
            document.getElementById('f-current-role').textContent = emp.originalDesignation;
            document.getElementById('f-retire-date').textContent = formatDate(emp.retirementDate);

            const tm = document.getElementById('timeline');
            tm.innerHTML = '';

            if (emp.history.length === 0) {
                tm.innerHTML = `<div class="text-slate-400 italic bg-slate-50 p-4 rounded text-center">No promotions forecasted before retirement.</div>`;
                return;
            }

            emp.history.forEach(h => {
                const item = document.createElement('div');
                item.className = 'relative fade-in pb-8 last:pb-0 h-full';
                item.innerHTML = `
                    <div class="absolute top-[28px] -left-[30px] bottom-0 w-0.5 bg-indigo-100 last:hidden"></div>
                    <div class="absolute top-[8px] -left-[39px] bg-indigo-600 h-5 w-5 rounded-full border-4 border-white z-10 shadow-sm"></div>
                    
                    <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center mb-1">
                        <div class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">${formatDate(h.date)}</div>
                    </div>
                    
                    <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow relative">
                        <div class="text-sm text-slate-400 mb-1">Promotion Event</div>
                        <div class="font-bold text-slate-800 text-lg">${h.role}</div>
                    </div>
                `;
                tm.appendChild(item);
            });
        }

        function renderStats() {
            // Role Counts
            const counts = {};
            HIERARCHY.forEach(r => counts[r] = 0);

            employees.forEach(e => {
                const role = e.originalDesignation;
                counts[role] = (counts[role] || 0) + 1;
            });

            // Parsing Report / Stats Container
            const container = document.getElementById('role-stats-container');
            const statsGrid = document.querySelector('#dashboard .grid'); // Needs to find insertion point carefully now that top stats are gone

            // Because we removed the top stats grid, the 'first grid' is now the main layout grid.
            // We want to insert this Role Distribution panel at the TOP of the dashboard.

            let breakdownDiv = container;
            if (!breakdownDiv) {
                breakdownDiv = document.createElement('div');
                breakdownDiv.id = 'role-stats-container';
                breakdownDiv.className = 'w-full bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8';

                // insert as first child of dashboard
                const dashboard = document.getElementById('dashboard');
                dashboard.insertBefore(breakdownDiv, dashboard.firstChild);
            }

            let html = `<div class="flex justify-between items-center mb-4">
                <h4 class="font-bold text-indigo-800 text-lg">Role Distribution</h4>
                <div class="text-sm font-semibold text-indigo-600 bg-white px-3 py-1 rounded border border-indigo-200 shadow-sm">
                    Total Employees: <span class="font-bold text-slate-800 text-lg ml-1">${employees.length}</span>
                </div>
            </div>`;

            html += `<div class="grid grid-cols-2 md:grid-cols-4 gap-4">`;

            [...HIERARCHY].reverse().forEach(role => {
                const count = counts[role];
                const color = count === 0 ? 'text-slate-400 bg-slate-100' : 'text-indigo-700 bg-white border-indigo-200';
                html += `
                    <div class="px-3 py-2 rounded border ${count === 0 ? 'border-transparent' : 'shadow-sm'} ${color} flex justify-between items-center">
                        <span class="text-sm font-medium">${role}</span>
                        <span class="font-bold font-mono">${count}</span>
                    </div>
                `;
            });
            html += `</div>`;

            // Also showing unmapped count if any
            const unmappedCount = employees.filter(e => !HIERARCHY.includes(e.originalDesignation)).length;
            if (unmappedCount > 0) {
                html += `<div class="mt-2 text-xs text-red-500">Note: ${unmappedCount} employees have designations not in the hierarchy.</div>`;
            }

            breakdownDiv.innerHTML = html;
        }

        function renderParsingReport() {
            const container = document.getElementById('parsing-report-container');
            if (unmappedRoles.size === 0) {
                if (container) container.classList.add('hidden');
                return;
            }

            // Inject container if missing
            if (!container) {
                const statsRow = document.querySelector('#dashboard .grid'); // First grid
                const reportDiv = document.createElement('div');
                reportDiv.id = 'parsing-report-container';
                reportDiv.className = 'col-span-1 md:col-span-3 bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-8 text-sm';
                statsRow.parentNode.insertBefore(reportDiv, statsRow.nextSibling);
            }

            const wrapper = document.getElementById('parsing-report-container');
            wrapper.classList.remove('hidden');

            let html = `<h4 class="font-bold text-yellow-800 mb-2">⚠️ Check Role Mappings</h4>`;
            html += `<p class="text-yellow-700 mb-2">The following "Remarks" did not match any known role and were defaulted to <b>Clerk</b>. If these are senior posts, the simulation will be incorrect.</p>`;
            html += `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">`;

            unmappedRoles.forEach((count, role) => {
                html += `<div class="bg-white px-2 py-1 rounded border border-yellow-100 text-slate-600 truncate" title="${role}">
                    <span class="font-mono font-bold text-xs bg-slate-100 px-1 rounded">${count}</span> ${role}
                </div>`;
            });
            html += `</div>`;
            wrapper.innerHTML = html;
        }

    </script>
</body>

</html>